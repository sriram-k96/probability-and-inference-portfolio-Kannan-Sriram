---
title: "08-coverage-probability"
author: ' Sriram Kannan'
date: "`r format(Sys.time(), '%29-%11-%2021')`"
output:
  html_document:
    code_folding: hide
    toc: yes
    number_sections: yes
    toc_depth: 3
    toc_float: yes
---

# Introduction
Coverage probability is an important operating characteristic of methods for constructing interval estimates, particularly confidence intervals. In this blog post, we will perform a simulation to calculate the coverage probability of the 95% confidence interval of the median when computed from the Maximum Likelihood Estimate of a Standard Normal Distribution with a Size of 201. 

#Background

For the Purpose of this blog post, we state the following definitions.

1) We define the 95% confidence interval of the median to be the middle 95% of sampling distribution of the median. Similarly, the 95% confidence interval of the mean, standard deviation, etc. is the middle 95% of the respective sampling distribution.

2)We define the coverage probability as the long run proportion of intervals that capture the population parameter of interest. 

Coverage Probabilty being Equal to the Confidence Interval is only true when the population is normally distributed (which is rarely true in reality) or if the sample sizes are large enough and independant that the Central Limit Theorem can be utilized (Any distribution can be approximated to a Normal Distribution). The aspects of Simulation discussed in this blog post will enable us to estimate the coverage probability for small samples when the population is not normal. We can also simulate from skewed or heavy-tailed distributions to see how skewness and kurtosis affect the coverage probability.

Confidence Intervals: 

A confidence interval is how much uncertainty there is with any particular statistic due to a sample being used as opposed to the population as a whole. A 95% confidence interval (most common) means that if an experiment is repeated over and over, then 95% of the results from the sample matches that of the population. Confidence Intervals can be generated by chopping off 2.5% on both sides equally in a symmetric distribution. In case of a skewed distribution we instead calculate the Highest Density Interval. 

# Methodology

We use Maximumum Likelihood Estimate to fit the data to the generated random sample of a standard normal distribution by solving for the Parameters (Mean and Standard Deviation in case of a Normal Distribution) which maximizes the likelihood of the generated data appearing the way it is.

```{r}
popmean = 0
popsd = 1
library(dplyr)
library(stats4)
params <- c(201, mean = popmean, sd = popsd)
data_gen <- function(coef)
{
 gen = rnorm(coef[1], coef[2], coef[3])
}
```


```{r}
mle_gen = function(data_gen)
{
  nLLdata <- function(mean = mean(data_gen), sd = sd(data_gen))
  {
    fs <- dnorm(
        x = data_gen
      , mean = mean
      , sd = sd
      , log = TRUE
    ) 
    -sum(fs)
  }

  fitnormdata <- mle(
    nLLdata
  , start = list(mean = 0, sd = 1)
  , method = "L-BFGS-B"
  , lower = c(0, 0.01)
  )
  return (c(length(data), coef(fitnormdata)[1], coef(fitnormdata)[2]))
}

```
We then generate the sampling distribution of the Median of the generated Normal Distribution using the Parameters estimated by the Maximum likelihood Estimate done previously. 

We Calculate the 0.025 and the 0.975th Quantiles in order to Generate the Confidence Interval. This can be done as the Normal Distribution is Symmetric in Nature. 
```{r}
median_dist <- function(coef)
{
  medians <- NA
  for (i in 1:1000)
  {
    medians[i] <- coef %>% data_gen() %>% median
  }
    quantile(medians,c(0.025, 0.975))
}
```

Below is an example of a 95% confidence interval generated by the sampling distribution of the median of a standard normal distribution. This process will be repeated many times to check if the population parameter lies within this interval. 
```{r}
params %>% data_gen %>% mle_gen %>% median_dist 

```
We then compare the values of the 2 ends of the confidence intervals to see if one lies below 0 and the other above. We do this because the population mean of the standard normal distribution (i.e our population parameter of interest) is 0. 
```{r}
coverage_region <- function(region)
{
  1*(region[1] < 0 & 0 < region[2])
}
```

```{r}
set.seed(2)
data <- rep(NA, 1000)
for (i in 1:1000)
{
  data[i] <- params %>% data_gen %>% mle_gen %>% median_dist %>% coverage_region
}
coverage_probability_median = mean(data)
coverage_probability_median

```
We thus find that our coverage probability is 0.888. That is, the population median is within the region covered by the 95% confidence interval of our generated standard normal distribution 88.8% of the time. 

Now, let's consider the mean instead of the median as our population parameter. The mean of a standard normal distribution is 0. 


```{r}
mean_dist <- function(coef)
{
  means <- NA
  for (i in 1:1000)
  {
    means[i] <- coef %>% data_gen() %>% mean
  }
    quantile(means ,c(0.025, 0.975))
}
```

```{r}
set.seed(2)
data2 <- rep(NA, 1000)
for (i in 1:1000)
{
  data2[i] <- params %>% data_gen %>% mle_gen %>% mean_dist %>% coverage_region
}
coverage_probability_mean = mean(data2)
coverage_probability_mean
```
We thus find that our coverage probability is 0.833 for the mean. That is, the mean is within the region covered by the 95% confidence interval of our generated standard normal distribution 83.3% of the time.




